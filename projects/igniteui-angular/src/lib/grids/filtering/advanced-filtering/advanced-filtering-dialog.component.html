<article class="igx-excel-filter__secondary"
         (keydown)="onKeyDown($event)"
         [ngClass]="{
             'igx-excel-filter__secondary--cosy': grid.displayDensity === 'cosy',
             'igx-excel-filter__secondary--compact': grid.displayDensity === 'compact'
         }">
    <header class="igx-excel-filter__secondary-header">
        <h4 class="igx-typography__h6">
            Adv. Filtering
        </h4>
    </header>

    <article #expressionsContainer class="igx-excel-filter__secondary-main" style="padding: 10px;">
        <ng-container *ngIf="!rootGroup">
            <button igxButton [displayDensity]="displayDensity" (click)="addAndGroup()">
                <igx-icon fontSet="material">add</igx-icon>
                <span>"And" Group</span>
            </button>
            <button igxButton [displayDensity]="displayDensity" (click)="addOrGroup()">
                <igx-icon fontSet="material">add</igx-icon>
                <span>"Or" Group</span>
            </button>
        </ng-container>

        <ng-template #addExpressionsTemplate let-expressionItem let-afterExpression="afterExpression">
            <button igxButton 
                    [displayDensity]="displayDensity"
                    [disabled]="editedExpression"
                    (click)="addCondition(expressionItem, afterExpression)">
                <igx-icon fontSet="material">add</igx-icon>
                <span>Condition</span>
            </button>
            <button igxButton
                    [displayDensity]="displayDensity"
                    [disabled]="editedExpression"
                    (click)="addAndGroup(expressionItem, afterExpression)">
                <igx-icon fontSet="material">add</igx-icon>
                <span>"And" Group</span>
            </button>
            <button igxButton
                    [displayDensity]="displayDensity"
                    [disabled]="editedExpression"
                    (click)="addOrGroup(expressionItem, afterExpression)">
                <igx-icon fontSet="material">add</igx-icon>
                <span>"Or" Group</span>
            </button>
        </ng-template>

        <ng-template #filterOperandTemplate let-expressionItem>
            <span *ngIf="!expressionItem.inEditMode">
                <igx-chip [data]="expressionItem"
                          [removable]="true"
                          [selected]="expressionItem.selected"
                          (click)="onChipClick(expressionItem)"
                          (dblclick)="onChipDblClick(expressionItem)"
                          (onRemove)="onChipRemove(expressionItem)"
                          style="margin-bottom: 10px">
                    {{ expressionItem.expression.fieldName }}
                    {{ expressionItem.expression.condition ? expressionItem.expression.condition.name : '' }}
                    {{ expressionItem.expression.searchVal }}
                </igx-chip>
                <span *ngIf="expressionItem.selected && selectedExpressions.length === 1">
                    <button igxButton="icon"
                            (click)="enterExpressionEdit(expressionItem)">
                        <igx-icon fontSet="material">edit</igx-icon>
                    </button>
                    <button igxButton="icon"
                            (click)="enterExpressionAdd(expressionItem)">
                        <igx-icon fontSet="material">add</igx-icon>
                    </button>
                </span>
            </span>
            <div *ngIf="expressionItem.inEditMode"
                 style="display: flex; align-items: center;">
                <igx-select type="box" 
                            [(ngModel)]="selectedColumn">
                    <igx-select-item *ngFor="let column of grid.columns" [value]="column">
                        {{column.header}}
                    </igx-select-item>
                </igx-select>

                <ng-container *ngIf="!selectedColumn">
                    <igx-select type="box"
                                [disabled]="true">
                    </igx-select>
                </ng-container>

                <ng-container *ngIf="selectedColumn">
                    <igx-select type="box" 
                                [(ngModel)]="selectedCondition"
                                [disabled]="!selectedColumn">
                            <igx-select-item *ngFor="let condition of selectedColumn.filters.conditionList()" [value]="condition">
                                {{condition}}
                            </igx-select-item>
                    </igx-select>
                </ng-container>

                <igx-input-group type="box"
                                 [disabled]="!selectedColumn || !selectedCondition || (selectedColumn && selectedColumn.filters.condition(selectedCondition).isUnary)"
                                 [displayDensity]="displayDensity">
                    <input #input
                           igxInput
                           [(ngModel)]="searchValue"/>
                </igx-input-group>

                <button igxButton="icon"
                        [disabled]="!selectedColumn || !selectedCondition || (!searchValue && !selectedColumn.filters.condition(selectedCondition).isUnary)"
                        (click)="commitOperandEdit(expressionItem)">
                    <igx-icon fontSet="material">check</igx-icon>
                </button>
                <button igxButton="icon"
                        (click)="cancelOperandEdit()">
                    <igx-icon fontSet="material">close</igx-icon>
                </button>
            </div>
            <div *ngIf="expressionItem.inAddMode"
                 style="display: flex;">
                <ng-container *ngTemplateOutlet="addExpressionsTemplate; context: context(expressionItem.parent, expressionItem)"></ng-container>
                <button igxButton="icon"
                        (click)="cancelOperandAdd()">
                    <igx-icon fontSet="material">close</igx-icon>
                </button>
            </div>
        </ng-template>

        <ng-template #expressionTreeTemplate let-expressionItem>
            <div style="display: flex;">
                <div tabindex="0" style="width: 10px; margin-right: 10px;"
                     [style.background-color]="expressionItem.operator === 0 ? expressionItem.selected ? 'blue' : 'lightblue' : expressionItem.selected ? 'red' : 'lightcoral'"
                     (click)="onGroupClick(expressionItem)"></div>
                <div style="display: flex; flex-direction: column; align-items: flex-start;">
                    <ng-container *ngFor="let expr of expressionItem.children">
                        <ng-container *ngTemplateOutlet="isExpressionGroup(expr) ? expressionTreeTemplate : filterOperandTemplate; context: context(expr)"></ng-container>
                    </ng-container>
                    <div *ngIf="currentGroup === expressionItem">
                        <ng-container *ngTemplateOutlet="addExpressionsTemplate; context: context(expressionItem)"></ng-container>
                        <button igxButton
                                *ngIf="expressionItem !== rootGroup"
                                [displayDensity]="displayDensity"
                                [disabled]="editedExpression"
                                (click)="endGroup(expressionItem)">
                            <span>End Group</span>
                        </button>
                    </div>
                </div>
            </div>
        </ng-template>

        <ng-container *ngIf="rootGroup">
            <ng-container *ngTemplateOutlet="expressionTreeTemplate; context: context(rootGroup)"></ng-container>
        </ng-container>

        <div igxToggle
             style="display: flex; flex-flow: column; width: 200px; background-color: black; margin-left: 20px">
            <ng-container *ngIf="selectedGroups.length === 1">
                <igx-buttongroup #logicOperatorButtonGroup
                                 [multiSelection]="false">
                    <span igxButton [displayDensity]="displayDensity"
                        #andButton
                        (keydown)="onLogicOperatorKeyDown(0)"
                        tabindex="0"
                        [selected]="selectedGroups[0].operator === 0"
                        type="button"
                        (click)="onLogicOperatorButtonClicked(0)">
                        {{ grid.resourceStrings.igx_grid_filter_operator_and }}
                    </span>
                
                    <span igxButton [displayDensity]="displayDensity"
                        #orButton
                        tabindex="0"
                        (keydown)="onLogicOperatorKeyDown(1)"
                        [selected]="selectedGroups[0].operator === 1"
                        type="button"
                        (click)="onLogicOperatorButtonClicked($event, 1)">
                        {{ grid.resourceStrings.igx_grid_filter_operator_or }}
                    </span>
                </igx-buttongroup>

                <button igxButton [displayDensity]="displayDensity" [disabled]="!selectedGroups[0].parent" (click)="ungroup()">
                    Ungroup
                </button>
                <button igxButton [displayDensity]="displayDensity" [disabled]="!selectedGroups[0].parent" (click)="deleteGroup()">
                    Delete
                </button>
            </ng-container>
            <ng-container *ngIf="selectedGroups.length !== 1 && selectedExpressions.length > 1">
                <button igxButton [displayDensity]="displayDensity" (click)="createAndGroup()">
                    Create "And" Group
                </button>
                <button igxButton [displayDensity]="displayDensity" (click)="createOrGroup()">
                    Create "Or" Group
                </button>
                <button igxButton [displayDensity]="displayDensity" (click)="deleteFilters()">
                    Delete Filters
                </button>
            </ng-container>
        </div>
    </article>

    <footer class="igx-excel-filter__secondary-footer">
        <button igxButton [displayDensity]="displayDensity" (click)="onClearButtonClick()">{{ grid.resourceStrings.igx_grid_excel_custom_dialog_clear }}</button>

        <div>
            <button igxButton [displayDensity]="displayDensity" (click)="closeDialog()">{{ grid.resourceStrings.igx_grid_excel_cancel }}</button>
            <button igxButton="raised" [displayDensity]="displayDensity" (click)="onApplyButtonClick()" (keydown)="onApplyButtonKeyDown($event)">
                {{ grid.resourceStrings.igx_grid_excel_apply }}
            </button>
        </div>
    </footer>
</article>
