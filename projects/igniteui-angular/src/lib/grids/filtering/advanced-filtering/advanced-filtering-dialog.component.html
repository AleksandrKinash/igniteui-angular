<article class="igx-excel-filter__secondary"
         igxDrag [renderGhost]="false" [dragTolerance]="0" (dragMove)="dragMove($event)"
         (keydown)="onKeyDown($event)"
         [ngClass]="{
             'igx-excel-filter__secondary--cosy': grid.displayDensity === 'cosy',
             'igx-excel-filter__secondary--compact': grid.displayDensity === 'compact'
         }">
    <header class="igx-excel-filter__secondary-header" igxDragHandle  style="user-select: none;">
        <h4 class="igx-typography__h6" style="pointer-events: none;">
            Adv. Filtering
        </h4>
        <div style="display: flex; margin-left: auto; pointer-events: none;">
            <div style="display: flex; margin-right: 25px">
                <div style="width: 24px; height: 24px; background: lightblue; margin-right: 8px; border-radius: 4px;"></div>
                and
            </div>
            <div style="display: flex; margin-right: 25px">
                <div style="width: 24px; height: 24px; background: lightcoral; margin-right: 8px; border-radius: 4px;"></div>
                or
            </div>
        </div>
    </header>

    <article #expressionsContainer class="igx-excel-filter__secondary-main" style="padding: 10px;">
        <ng-container *ngIf="!rootGroup">
            <button igxButton="outlined" [displayDensity]="displayDensity" (click)="addAndGroup()">
                <igx-icon fontSet="material">add</igx-icon>
                <span>"And" Group</span>
            </button>
            <button igxButton="outlined" [displayDensity]="displayDensity" (click)="addOrGroup()">
                <igx-icon fontSet="material">add</igx-icon>
                <span>"Or" Group</span>
            </button>

            <div style="display: flex; width: 100%;">
                <span style="display: flex; margin: auto;">
                    Start with creating a group of conditions linked with "And" or "Or"
                </span>                
            </div>
        </ng-container>

        <ng-template #addExpressionsTemplate let-expressionItem let-afterExpression="afterExpression">
            <button igxButton="outlined" 
                    [displayDensity]="displayDensity"
                    [disabled]="editedExpression"
                    (click)="addCondition(expressionItem, afterExpression)">
                <igx-icon fontSet="material">add</igx-icon>
                <span>Condition</span>
            </button>
            <button igxButton="outlined"
                    [displayDensity]="displayDensity"
                    [disabled]="editedExpression"
                    (click)="addAndGroup(expressionItem, afterExpression)">
                <igx-icon fontSet="material">add</igx-icon>
                <span>"And" Group</span>
            </button>
            <button igxButton="outlined"
                    [displayDensity]="displayDensity"
                    [disabled]="editedExpression"
                    (click)="addOrGroup(expressionItem, afterExpression)">
                <igx-icon fontSet="material">add</igx-icon>
                <span>"Or" Group</span>
            </button>
        </ng-template>

        <ng-template #filterOperandTemplate let-expressionItem>
            <span *ngIf="!expressionItem.inEditMode">
                <igx-chip [data]="expressionItem"
                          [displayDensity]="displayDensity"
                          [removable]="true"
                          [selected]="expressionItem.selected"
                          (click)="onChipClick(expressionItem)"
                          (dblclick)="onChipDblClick(expressionItem)"
                          (onRemove)="onChipRemove(expressionItem)"
                          style="margin-bottom: 10px">
                    {{ expressionItem.expression.fieldName }}
                    <igx-icon fontSet="filtering-icons"
                              [name]="expressionItem.expression.condition.iconName"></igx-icon>
                    {{ getConditionFriendlyName(expressionItem.expression.condition.name) }}
                    <span *ngIf="!expressionItem.expression.condition.isUnary">
                        {{ isDate(expressionItem.expression.searchVal) ? (expressionItem.expression.searchVal | igxdate:grid.locale) : expressionItem.expression.searchVal }}
                    </span>
                </igx-chip>
                <span *ngIf="expressionItem.selected && selectedExpressions.length === 1">
                    <button igxButton="icon"
                            [displayDensity]="displayDensity"
                            (click)="enterExpressionEdit(expressionItem)">
                        <igx-icon fontSet="material">edit</igx-icon>
                    </button>
                    <button *ngIf="expressionItem.parent !== currentGroup || expressionItem !== currentGroup.children[currentGroup.children.length - 1]"
                            igxButton="icon"
                            [displayDensity]="displayDensity"
                            (click)="enterExpressionAdd(expressionItem)">
                        <igx-icon fontSet="material">add</igx-icon>
                    </button>
                </span>
            </span>
            <div *ngIf="expressionItem.inEditMode"
                 style="display: flex; align-items: center;">
                <igx-select #columnSelect
                            type="box"
                            [displayDensity]="displayDensity"
                            [(ngModel)]="selectedColumn">
                    <igx-select-item *ngFor="let column of filterableColumns" [value]="column">
                        {{column.header}}
                    </igx-select-item>
                </igx-select>

                <ng-container *ngIf="!selectedColumn">
                    <igx-select type="box"
                                [displayDensity]="displayDensity"
                                [disabled]="true">
                    </igx-select>
                </ng-container>

                <ng-container *ngIf="selectedColumn">
                    <igx-select #conditionSelect
                                type="box" 
                                [displayDensity]="displayDensity"
                                [(ngModel)]="selectedCondition"
                                [disabled]="!selectedColumn">
                            <igx-select-item *ngFor="let condition of selectedColumn.filters.conditionList()" [value]="condition">
                                {{getConditionFriendlyName(condition)}}
                            </igx-select-item>
                    </igx-select>
                </ng-container>

                <igx-input-group *ngIf="!selectedColumn || selectedColumn.dataType !== 'date'"
                                 type="box"
                                 [disabled]="!selectedColumn || !selectedCondition || (selectedColumn && selectedColumn.filters.condition(selectedCondition).isUnary)"
                                 [displayDensity]="displayDensity">
                    <input #searchValueInput
                           igxInput
                           [(ngModel)]="searchValue"/>
                </igx-input-group>

                <igx-date-picker *ngIf="selectedColumn && selectedColumn.dataType === 'date'" 
                                 mode="dropdown"
                                 [(ngModel)]="searchValue"
                                 [locale]="grid.locale"
                                 [outlet]="grid.outletDirective">
                    <ng-template igxDatePickerTemplate let-openDialog="openDialog" let-value="value">
                        <igx-input-group #dropDownTarget type="box" [displayDensity]="displayDensity" [supressInputAutofocus]="true">
                            <input #input
                                    igxInput
                                    tabindex="0"
                                    (click)="openDialog(dropDownTarget.element.nativeElement)"
                                    [placeholder]="inputDatePlaceholder"
                                    autocomplete="off"
                                    [value]="value | igxdate: grid.locale"
                                    [readonly]="true"
                                    [disabled]="!selectedColumn || !selectedCondition || (selectedColumn && selectedColumn.filters.condition(selectedCondition).isUnary)"/>
                        </igx-input-group>
                    </ng-template>
                </igx-date-picker>

                <button igxButton="icon"
                        [displayDensity]="displayDensity"
                        [disabled]="!operandCanBeCommitted()"
                        (click)="commitOperandEdit()">
                    <igx-icon fontSet="material">check</igx-icon>
                </button>
                <button igxButton="icon"
                        [displayDensity]="displayDensity"
                        (click)="cancelOperandEdit()">
                    <igx-icon fontSet="material">close</igx-icon>
                </button>
            </div>
            <div *ngIf="expressionItem.inAddMode"
                 style="display: flex;">
                <ng-container *ngTemplateOutlet="addExpressionsTemplate; context: context(expressionItem.parent, expressionItem)"></ng-container>
                <button igxButton="icon"
                        [displayDensity]="displayDensity"
                        (click)="cancelOperandAdd()">
                    <igx-icon fontSet="material">close</igx-icon>
                </button>
            </div>
        </ng-template>

        <ng-template #expressionTreeTemplate let-expressionItem>
            <div style="display: flex;">
                <div tabindex="0" style="width: 10px; margin-right: 10px;"
                     [style.background-color]="expressionItem.operator === 0 ? expressionItem.selected ? 'blue' : 'lightblue' : expressionItem.selected ? 'red' : 'lightcoral'"
                     (click)="onGroupClick(expressionItem)"></div>
                <div style="display: flex; flex-direction: column; align-items: flex-start;">
                    <ng-container *ngFor="let expr of expressionItem.children">
                        <ng-container *ngTemplateOutlet="isExpressionGroup(expr) ? expressionTreeTemplate : filterOperandTemplate; context: context(expr)"></ng-container>
                    </ng-container>
                    <div *ngIf="currentGroup === expressionItem">
                        <ng-container *ngTemplateOutlet="addExpressionsTemplate; context: context(expressionItem)"></ng-container>
                        <button igxButton="outlined"
                                *ngIf="expressionItem !== rootGroup"
                                [displayDensity]="displayDensity"
                                [disabled]="editedExpression || expressionItem.children.length < 2"
                                (click)="endGroup(expressionItem)">
                            <span>End Group</span>
                        </button>
                    </div>
                </div>
            </div>
        </ng-template>

        <ng-container *ngIf="rootGroup">
            <ng-container *ngTemplateOutlet="expressionTreeTemplate; context: context(rootGroup)"></ng-container>
        </ng-container>

        <div igxToggle
             style="display: flex; flex-flow: column; width: 200px; background-color: black; margin-left: 20px">
            <ng-container *ngIf="contextualGroup">
                <igx-buttongroup [displayDensity]="displayDensity"
                                 [multiSelection]="false"
                                 [values]="filteringLogics"
                                 (onSelect)="selectFilteringLogic($event)">
                </igx-buttongroup>

                <button igxButton="outlined" [displayDensity]="displayDensity" [disabled]="!contextualGroup.parent" (click)="ungroup()">
                    Ungroup
                </button>
                <button igxButton="outlined" [displayDensity]="displayDensity" (click)="deleteGroup()">
                    Delete
                </button>
            </ng-container>
            <ng-container *ngIf="!contextualGroup">
                <button igxButton="outlined" [displayDensity]="displayDensity" (click)="createAndGroup()">
                    Create "And" Group
                </button>
                <button igxButton="outlined" [displayDensity]="displayDensity" (click)="createOrGroup()">
                    Create "Or" Group
                </button>
                <button igxButton="outlined" [displayDensity]="displayDensity" (click)="deleteFilters()">
                    Delete Filters
                </button>
            </ng-container>
        </div>
    </article>

    <footer class="igx-excel-filter__secondary-footer">
        <button igxButton [displayDensity]="displayDensity" (click)="onClearButtonClick()">{{ grid.resourceStrings.igx_grid_excel_custom_dialog_clear }}</button>

        <div>
            <button igxButton [displayDensity]="displayDensity" (click)="closeDialog()">{{ grid.resourceStrings.igx_grid_excel_cancel }}</button>
            <button igxButton="raised" [displayDensity]="displayDensity" (click)="onApplyButtonClick()" (keydown)="onApplyButtonKeyDown($event)">
                {{ grid.resourceStrings.igx_grid_excel_apply }}
            </button>
        </div>
    </footer>
</article>
